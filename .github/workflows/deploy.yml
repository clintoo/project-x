name: Deploy to Netlify via Shared Workflow

on:
  push:
    branches:
      - main
      - dev

jobs:
  deploy:
    uses: clintoo/ci-pipelines/.github/workflows/deploy.yml@main
    with:
      environment: ${{ github.ref == 'refs/heads/main' && 'production' || 'development' }}
      url: ${{ github.ref == 'refs/heads/main' && 'https://xtremeart.netlify.app' || 'https://formyeyes.netlify.app' }}
      production: ${{ github.ref == 'refs/heads/main' }}
    secrets:
      ACCESS_TOKEN: ${{ secrets.ACCESS_TOKEN }}
      PROD_ID: ${{ secrets.PROD_ID }}
      STAGING_ID: ${{ secrets.STAGING_ID }}

  create-issue-on-failure:
    runs-on: ubuntu-latest
    needs: deploy
    if: failure()
    steps:
      - name: Create GitHub Issue on Failure
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const title = 'ðŸš¨ Deployment Failed';
            const body = `The deployment job failed for branch: \`${{ github.ref }}\`.

            Please check the workflow run for details: [View Run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})

            cc @${{ github.actor }}`;
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title,
              body,
            });
